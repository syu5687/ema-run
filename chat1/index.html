<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ihg Best Match | フォーム→チャットボット化（v3.0 安定版）</title>
  <link rel="icon" href="data:,">
  <style>
	:root{--teal:#0e7490;--hdr:#083344;--blue:#2563eb;}
	body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",Helvetica,Arial,sans-serif;}

	/* ランチャー */
	.chat-launcher{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);display:flex;align-items:center;gap:10px;background:var(--teal);color:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:2147483000;cursor:pointer;min-width:320px}
	.chat-launcher .chev{margin-left:6px;transition:transform .2s ease}
	.chat-launcher[aria-expanded="true"] .chev{transform:rotate(180deg)}
	@media(max-width:640px){.chat-launcher{left:0;right:0;bottom:0;transform:none;border-radius:0;justify-content:center;min-width:unset;width:100%}}

	/* チャットウィンドウ */
	.chat{position:fixed;right:20px;bottom:96px;width:min(420px,calc(100vw - 40px));height:70vh;max-height:620px;border-radius:16px;background:#fff;box-shadow:0 20px 40px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;z-index:2147483001;opacity:0;visibility:hidden;pointer-events:none;transform:translateY(18px) scale(.98);transition:transform .28s,opacity .18s,visibility 0s linear .18s}
	.chat.open{opacity:1;visibility:visible;pointer-events:auto;transform:none}
	@media(max-width:640px){.chat{right:0;left:0;bottom:0;top:0;width:100vw;height:100vh;max-height:none;border-radius:0;transform:translateY(100%)}.chat.open{transform:translateY(0)}}

	.chat-header{padding:14px 16px;background:var(--hdr);color:#fff;display:flex;justify-content:space-between;align-items:center}
	.chat-body{padding:12px;gap:8px;display:flex;flex-direction:column;overflow-y:auto;background:#f8fafc}
	.sys,.user{max-width:86%;padding:10px 12px;border-radius:14px;font-size:14px;white-space:pre-wrap}
	.sys{background:#e2f0f6;align-self:flex-start}
	.user{background:#fff;align-self:flex-end;border:1px solid #e5e7eb}
	.chat-footer{padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px;background:#fff}
	.chat-footer input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px}
	.chat-footer button{padding:10px 14px;border:0;border-radius:10px;background:var(--teal);color:#fff;cursor:pointer}

	/* 選択肢 */
	.choices{display:flex;flex-wrap:wrap;gap:6px 8px}
	.pill{padding:6px 12px;font-size:14px;border:1px solid #cbd5e1;border-radius:20px;background:#fff;cursor:pointer}
	.pill.selected{background:var(--teal);color:#fff;border-color:var(--teal)}
	.pill.disabled{opacity:.5;pointer-events:none}
	.confirm{border:1px solid var(--blue);background:#fff;color:var(--blue)}
	.confirm.active{background:var(--blue);color:#fff;border-color:var(--blue);animation:pulse 1s ease-in-out infinite}
	@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(37,99,235,.5)}50%{box-shadow:0 0 0 8px rgba(37,99,235,0)}}

	/* ローディングスピナー */
	.loading{position:absolute;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:10}
	.loading.active{display:flex}
	.spinner{width:48px;height:48px;border:4px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
	@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="chat-launcher" id="launcher" role="button" tabindex="0" aria-controls="chatBox" aria-expanded="false"><span>💬 ご相談チャット</span><span class="chev">▴</span></div>
  <section class="chat" id="chatBox" role="dialog" aria-hidden="true">
	<div class="chat-header"><span>ご相談チャット</span><button id="closeBtn">×</button></div>
	<div class="chat-body" id="chat"></div>
	<div class="chat-footer"><input id="textInput" placeholder="ここに入力…" /><button id="sendBtn">送信</button></div>
	<div class="loading" id="loading"><div class="spinner"></div></div>
  </section>
<script>
(function(){
  // 質問フロー定義
  const FLOW=[
	{ key:'visited_before', label:'当館にお越しいただいたことはありますか？', type:'singleChoice', options:['なし','ある（結婚式）','ある（宴会）'] },
	{ key:'tour_status', label:'式場見学状況は？', type:'singleChoice', options:['初めて','2式場目','3式場目','4式場以上'] },
	{ key:'ceremony_style', label:'挙式スタイル（複数可）', type:'multiChoice', options:['チャペル挙式','人前式（チャペル内・会場内）','神前式','ご披露宴のみ','その他'] },
	{ key:'guest_counts_groom', label:'ご予定人数（新郎側）', type:'text' },
	{ key:'guest_counts_bride', label:'ご予定人数（新婦側）', type:'text' },
	{ key:'season_preference', label:'ご希望の時期を選択してください', type:'singleChoice', options:['春','夏','秋','冬','未定'] },
	{ key:'time_band', label:'時間帯のご希望', type:'singleChoice', options:['昼食にパーティーを合わせたい','夕食にパーティーを合わせたい'] },
	{ key:'costume', label:'衣裳（複数可）', type:'multiChoice', options:['ウェディングドレス','カクテルドレス','白無垢','色打掛','タキシード','紋付袴'] },
	{ key:'groom_name', label:'新郎様のお名前（例：佐賀 太郎）', type:'text', required:true },
	{ key:'bride_name', label:'新婦様のお名前（例：佐賀 花子）', type:'text', required:true },
	{ key:'phone', label:'電話番号（ハイフン可）', type:'tel', required:true },
	{ key:'email', label:'メールアドレス', type:'email', required:true },
	{ key:'address', label:'ご住所（市区町村以降）', type:'text', required:true },
	{ key:'has_kids', label:'お子様はいらっしゃいますか？', type:'singleChoice', options:['あり','なし'] },
	{ key:'visit_1st', label:'来館希望日（第1希望）をカレンダーから選択してください', type:'date', required:true },
	{ key:'visit_2nd', label:'来館希望日（第2希望）をカレンダーから選択してください', type:'date', required:true },
	{ key:'consent', label:'個人情報保護方針に同意いただけますか？「同意します」と入力してください。', type:'consent', required:true }
  ];

  const state={step:0,answers:{},started:false};
  const chat=document.getElementById('chat');
  const textInput=document.getElementById('textInput');
  const sendBtn=document.getElementById('sendBtn');
  const widget=document.getElementById('chatBox');
  const launcher=document.getElementById('launcher');
  const closeBtn=document.getElementById('closeBtn');
  const loading=document.getElementById('loading');

  // ユーティリティ
  function bubble(txt,who='sys'){const d=document.createElement('div');d.className=who;d.textContent=txt;chat.appendChild(d);chat.scrollTop=chat.scrollHeight}
  const todayISO=()=>new Date().toISOString().slice(0,10);

  // 質問レンダリング
  function renderChoices(q){
	const wrap=document.createElement('div');wrap.className='sys choices';wrap.dataset.step=state.step;
	if(q.type==='singleChoice'){
	  q.options.forEach(opt=>{const b=document.createElement('button');b.type='button';b.className='pill';b.textContent=opt;b.addEventListener('click',()=>{disableChoices(wrap);handleAnswer(opt);});wrap.appendChild(b)});
	} else { // multi
	  const selected=new Set();
	  q.options.forEach(opt=>{const b=document.createElement('button');b.type='button';b.className='pill';b.textContent=opt;b.addEventListener('click',()=>{b.classList.toggle('selected');b.classList.contains('selected')?selected.add(opt):selected.delete(opt);updateConfirm();});wrap.appendChild(b)});
	  const ok=document.createElement('button');ok.type='button';ok.className='pill confirm';ok.textContent='選択を確定';
	  function updateConfirm(){const n=selected.size;if(n>0){ok.classList.add('active');ok.textContent=`選択を確定（${n}）`;}else{ok.classList.remove('active');ok.textContent='選択を確定';}}
	  ok.addEventListener('click',()=>{disableChoices(wrap);handleAnswer(Array.from(selected));});wrap.appendChild(ok);
	}
	chat.appendChild(wrap);chat.scrollTop=chat.scrollHeight;
  }
  function disableChoices(wrap){wrap.querySelectorAll('button').forEach(b=>b.classList.add('disabled'));}

  // 質問進行
  function ask(){
	if(state.step>=FLOW.length){return finish();}
	const q=FLOW[state.step];
	bubble(`Q${state.step+1}：${q.label}`);
	if(q.type==='singleChoice'||q.type==='multiChoice') renderChoices(q);
	// 入力欄制御
	if(q.type==='date'){textInput.type='date';textInput.min=todayISO();textInput.value=todayISO();}
	else if(q.type==='email'){textInput.type='email';textInput.value='';}
	else if(q.type==='tel'){textInput.type='tel';textInput.value='';}
	else{textInput.type='text';textInput.value='';}
	textInput.focus();
  }

  // 回答処理
  function handleAnswer(val){
	const q=FLOW[state.step];
	const raw=(val!==undefined)?val:(textInput.value||'').trim();
	if(q.required){
	  if(q.type==='consent'){if(raw!=='同意します'){bubble('「同意します」と入力してください');return;}}
	  else if(Array.isArray(raw)?raw.length===0:!raw){bubble('必須入力です');return;}
	}
	bubble(Array.isArray(raw)?raw.join('、'):raw,'user');
	state.answers[q.key]=raw;state.step++;
	loading.classList.add('active');
	setTimeout(()=>{loading.classList.remove('active');ask();},500);
  }

  // 完了
  function finish(){
	loading.classList.add('active');
	setTimeout(()=>{loading.classList.remove('active');bubble('送信が完了しました！');},800);
  }

  // 開閉制御（安定版）
  let toggleBusy=false;
  function openWidget(){widget.classList.add('open');launcher.setAttribute('aria-expanded','true');widget.setAttribute('aria-hidden','false');if(!state.started){state.started=true;bubble('ご相談ありがとうございます！いくつかの質問にお答えください。');ask();}}
  function closeWidget(){widget.classList.remove('open');launcher.setAttribute('aria-expanded','false');widget.setAttribute('aria-hidden','true');}
  function toggleWidget(){if(toggleBusy) return;toggleBusy=true;setTimeout(()=>toggleBusy=false,200);widget.classList.contains('open')?closeWidget():openWidget();}

  launcher.onclick=toggleWidget;
  closeBtn.onclick=closeWidget;
  sendBtn.onclick=()=>handleAnswer();
  document.addEventListener('keydown',e=>{if(e.key==='Escape') closeWidget();});

  // 初期は閉じる
  closeWidget();
})();
</script>
</body>
</html>
