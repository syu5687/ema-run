<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ihg Best Match | フォーム→チャットボット化（v2.2 確定ボタン点滅復活）</title>
  <link rel="icon" href="data:,">
  <style>
	:root{--teal:#0e7490;--hdr:#083344;--blue:#2563eb;}
	body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",Helvetica,Arial,sans-serif;}
	.chat-launcher{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);display:flex;align-items:center;gap:10px;background:var(--teal);color:#fff;border-radius:12px;padding:12px 16px;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:2147483000;cursor:pointer;min-width:320px}
	.chat-launcher .chev{margin-left:6px;transition:transform .2s ease}
	.chat-launcher[aria-expanded="true"] .chev{transform:rotate(180deg)}
	@media(max-width:640px){.chat-launcher{left:0;right:0;bottom:0;transform:none;border-radius:0;justify-content:center;min-width:unset;width:100%}}

	.chat{position:fixed;right:20px;bottom:96px;width:min(420px,calc(100vw - 40px));height:70vh;max-height:620px;border-radius:16px;background:#fff;box-shadow:0 20px 40px rgba(0,0,0,.25);display:flex;flex-direction:column;overflow:hidden;z-index:2147483001;opacity:0;visibility:hidden;pointer-events:none;transform:translateY(18px) scale(.98);transition:transform .28s,opacity .18s,visibility 0s linear .18s}
	.chat.open{opacity:1;visibility:visible;pointer-events:auto;transform:none}
	@media(max-width:640px){.chat{right:0;left:0;bottom:0;top:0;width:100vw;height:100vh;max-height:none;border-radius:0;transform:translateY(100%)}.chat.open{transform:translateY(0)}}
	.chat-header{padding:14px 16px;background:var(--hdr);color:#fff;display:flex;justify-content:space-between;align-items:center}
	.chat-body{padding:12px;gap:8px;display:flex;flex-direction:column;overflow-y:auto;background:#f8fafc}
	.sys,.user{max-width:86%;padding:10px 12px;border-radius:14px;font-size:14px;white-space:pre-wrap}
	.sys{background:#e2f0f6;align-self:flex-start}
	.user{background:#fff;align-self:flex-end;border:1px solid #e5e7eb}
	.chat-footer{padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px;background:#fff}
	.chat-footer input{padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px}
	.chat-footer button{padding:10px 14px;border:0;border-radius:10px;background:var(--teal);color:#fff;cursor:pointer}
	.choices{display:flex;flex-wrap:wrap;gap:6px 8px}
	.pill{padding:6px 12px;font-size:14px;border:1px solid #cbd5e1;border-radius:20px;background:#fff;cursor:pointer}
	.pill.selected{background:var(--teal);color:#fff;border-color:var(--teal)}
	.pill.disabled{opacity:.5;pointer-events:none}
	.confirm{border:1px solid var(--blue);background:#fff;color:var(--blue)}
	.confirm.active{background:var(--blue);color:#fff;border-color:var(--blue);animation:pulse 1s ease-in-out infinite}
	@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(37,99,235,.5)}50%{box-shadow:0 0 0 8px rgba(37,99,235,0)}}
	  /* ローディングスピナー */
	.loading{position:absolute;inset:0;background:rgba(255,255,255,.85);display:none;align-items:center;justify-content:center;z-index:10}
	.loading.active{display:flex}
	.spinner{width:48px;height:48px;border:4px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
	@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="chat-launcher" id="launcher" role="button" tabindex="0" aria-controls="chatBox" aria-expanded="false"><span>💬 ご相談チャット</span><span class="chev">▴</span></div>
  <section class="chat" id="chatBox" role="dialog" aria-hidden="true">
	<div class="chat-header"><span>ご相談チャット</span><button id="closeBtn">×</button></div>
	<div class="chat-body" id="chat"></div>
	<div class="chat-footer"><input id="textInput" placeholder="ここに入力…" /><button id="sendBtn">送信</button></div>
	<div class="loading" id="loading"><div class="spinner"></div></div>
  </section>
<script>
(function(){
  const FLOW=[
	{key:'visited_before',label:'当館にお越しいただいたことはありますか？',type:'singleChoice',options:['なし','ある（結婚式）','ある（宴会）']},
	{key:'tour_status',label:'式場見学状況は？',type:'singleChoice',options:['初めて','2式場目','3式場目','4式場以上']},
	{key:'ceremony_style',label:'挙式スタイル（複数可）',type:'multiChoice',options:['チャペル挙式','人前式（チャペル内・会場内）','神前式','ご披露宴のみ','その他']},
	{key:'guest_counts_groom',label:'ご予定人数（新郎側）',type:'text'},
	{key:'guest_counts_bride',label:'ご予定人数（新婦側）',type:'text'}
  ];
  const state={step:0,answers:{},started:false};
  const chat=document.getElementById('chat');
  const textInput=document.getElementById('textInput');
  const sendBtn=document.getElementById('sendBtn');
  const widget=document.getElementById('chatBox');
  const launcher=document.getElementById('launcher');
  const closeBtn=document.getElementById('closeBtn');
  const loading=document.getElementById('loading');

  function bubble(txt,who='sys'){const d=document.createElement('div');d.className=who;d.textContent=txt;chat.appendChild(d);chat.scrollTop=chat.scrollHeight}

  function renderChoices(q){
	const wrap=document.createElement('div');wrap.className='sys choices';
	if(q.type==='singleChoice'){
	  q.options.forEach(opt=>{const b=document.createElement('button');b.type='button';b.className='pill';b.textContent=opt;b.addEventListener('click',()=>{disableChoices(wrap);handleAnswer(opt);});wrap.appendChild(b)});
	} else { // multiChoice
	  const selected=new Set();
	  q.options.forEach(opt=>{const b=document.createElement('button');b.type='button';b.className='pill';b.textContent=opt;b.addEventListener('click',()=>{b.classList.toggle('selected');b.classList.contains('selected')?selected.add(opt):selected.delete(opt);updateConfirm();});wrap.appendChild(b)});
	  const ok=document.createElement('button');ok.type='button';ok.className='pill confirm';ok.textContent='選択を確定';
	  function updateConfirm(){const n=selected.size;if(n>0){ok.classList.add('active');ok.textContent=`選択を確定（${n}）`;}else{ok.classList.remove('active');ok.textContent='選択を確定';}}
	  ok.addEventListener('click',()=>{disableChoices(wrap);handleAnswer(Array.from(selected));});wrap.appendChild(ok);
	}
	chat.appendChild(wrap);chat.scrollTop=chat.scrollHeight;
  }

  function disableChoices(wrap){ wrap.querySelectorAll('button').forEach(b=>b.classList.add('disabled')); }

  function ask(){
	if(state.step>=FLOW.length){bubble('ありがとうございます！');return;}
	const q=FLOW[state.step];
	bubble(`Q${state.step+1}：${q.label}`);
	if(q.type==='singleChoice'||q.type==='multiChoice') renderChoices(q);
  }

  function handleAnswer(val){
	const q=FLOW[state.step];
	bubble(Array.isArray(val)?val.join('、'):val,'user');
	state.answers[q.key]=val;state.step++;
	// 送信演出：0.5秒スピナー
	loading.classList.add('active');
	setTimeout(()=>{ loading.classList.remove('active'); ask(); },500);
  }

  function openWidget(){widget.classList.add('open');launcher.setAttribute('aria-expanded','true');if(!state.started){state.started=true;bubble('ご相談ありがとうございます！いくつかの質問にお答えください。');ask();}}
  function closeWidget(){widget.classList.remove('open');launcher.setAttribute('aria-expanded','false');}
  function toggleWidget(){widget.classList.contains('open')?closeWidget():openWidget();}

  launcher.addEventListener('click',toggleWidget);
  closeBtn.addEventListener('click',closeWidget);
  sendBtn.addEventListener('click',()=>handleAnswer(textInput.value.trim()));
})();
</script>
</body>
</html>
